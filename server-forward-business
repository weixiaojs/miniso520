#!/usr/bin/env bash
set -euo pipefail

APP_NAME="hippo-forward-business"
BASE_DIR="/usr/local/${APP_NAME}"
ENV_FILE="${BASE_DIR}/.env"
COMPOSE_FILE="${BASE_DIR}/docker-compose.yml"
INIT_DIR="${BASE_DIR}/initdb"

DEFAULT_SQL_URL="https://gitlab.com/miniso520/download/-/raw/main/server-forward-business/hippo-forward-business.sql"

usage() {
  cat <<'EOF'
Usage:
  install.sh                å®‰è£…/æ›´æ–°ï¼ˆé»˜è®¤ï¼‰
  install.sh uninstall      åœæ­¢å¹¶åˆ é™¤å®¹å™¨ï¼ˆä¿ç•™æ•°æ®å·ï¼‰
  install.sh purge          åœæ­¢å¹¶åˆ é™¤å®¹å™¨ + åˆ é™¤æ•°æ®å·ï¼ˆæ¸…ç©ºæ•°æ®åº“ï¼‰
  install.sh status         æŸ¥çœ‹çŠ¶æ€
  install.sh logs backend   çœ‹åŽç«¯æ—¥å¿—
EOF
}

need_cmd() { command -v "$1" >/dev/null 2>&1 || { echo "âŒ ç¼ºå°‘å‘½ä»¤: $1"; exit 1; }; }

rand_pass() {
  if command -v openssl >/dev/null 2>&1; then
    openssl rand -base64 18 | tr -d '\n'
  else
    date +%s%N | sha256sum | head -c 24
  fi
}

ensure_dirs() { mkdir -p "${BASE_DIR}" "${INIT_DIR}"; }

ensure_compose() {
  if docker compose version >/dev/null 2>&1; then return 0; fi
  echo "âŒ æœªæ£€æµ‹åˆ° docker compose æ’ä»¶ã€‚è¯·å…ˆå®‰è£… Docker Compose v2ï¼ˆdocker composeï¼‰ã€‚"
  exit 1
}

write_env_if_missing() {
  if [[ -f "${ENV_FILE}" ]]; then return 0; fi

  echo "ðŸ§¾ é¦–æ¬¡å®‰è£…ï¼Œç”Ÿæˆ .envï¼ˆä½ ä¹Ÿå¯ä»¥ä¹‹åŽæ‰‹åŠ¨æ”¹ ${ENV_FILE}ï¼‰"
  read -r -p "å‰ç«¯ç«¯å£ FRONT_PORTï¼ˆé»˜è®¤ 8080ï¼‰: " FRONT_PORT || true
  FRONT_PORT="${FRONT_PORT:-8080}"
  read -r -p "åŽç«¯ API ç«¯å£ API_PORTï¼ˆé»˜è®¤ 18181ï¼‰: " API_PORT || true
  API_PORT="${API_PORT:-18181}"
  read -r -p "åŽç«¯ WS ç«¯å£ WS_PORTï¼ˆé»˜è®¤ 18182ï¼‰: " WS_PORT || true
  WS_PORT="${WS_PORT:-18182}"

  MYSQL_ROOT_PASSWORD="$(rand_pass)"
  MYSQL_PASSWORD="$(rand_pass)"
  REDIS_PASSWORD="$(rand_pass)"
  JWT_SECRET="$(rand_pass)$(rand_pass)"

  cat >"${ENV_FILE}" <<EOF
FRONT_PORT=${FRONT_PORT}
API_PORT=${API_PORT}
WS_PORT=${WS_PORT}

MYSQL_IMAGE=mysql:5.7.44
MYSQL_DATABASE=hippo_forward
MYSQL_USER=hippo
MYSQL_PASSWORD=${MYSQL_PASSWORD}
MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}

REDIS_IMAGE=redis:7.4-alpine
REDIS_PASSWORD=${REDIS_PASSWORD}

BACKEND_IMAGE=miniso522/hippo-forward-backend-business:latest
FRONTEND_IMAGE=miniso522/hippo-forward-frontend-business:latest

JWT_SECRET=${JWT_SECRET}
SQL_URL=${DEFAULT_SQL_URL}
EOF

  echo "âœ… å·²ç”Ÿæˆ ${ENV_FILE}"
}

download_init_sql() {
  source "${ENV_FILE}"
  local sql_url="${SQL_URL:-$DEFAULT_SQL_URL}"
  local sql_path="${INIT_DIR}/00-init.sql"

  if [[ -s "${sql_path}" ]]; then
    echo "âœ… åˆå§‹åŒ– SQL å·²å­˜åœ¨: ${sql_path}"
    return 0
  fi

  echo "â¬‡ï¸  ä¸‹è½½åˆå§‹åŒ– SQL: ${sql_url}"
  need_cmd curl
  curl -fsSL "${sql_url}" -o "${sql_path}"
  echo "âœ… å·²ä¿å­˜åˆå§‹åŒ– SQL: ${sql_path}"
}

write_compose() {
  cat >"${COMPOSE_FILE}" <<'EOF'
services:
  hippo-mysql:
    image: ${MYSQL_IMAGE}
    container_name: hippo-mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - hippo_mysql_data:/var/lib/mysql
      - ./initdb:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -uroot -p${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [hippo-net]

  hippo-redis:
    image: ${REDIS_IMAGE}
    container_name: hippo-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--requirepass", "${REDIS_PASSWORD}"]
    volumes:
      - hippo_redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep PONG"]
      interval: 5s
      timeout: 3s
      retries: 30
    networks: [hippo-net]

  hippo-backend:
    image: ${BACKEND_IMAGE}
    container_name: hippo-backend
    restart: unless-stopped
    depends_on:
      hippo-mysql: { condition: service_healthy }
      hippo-redis: { condition: service_healthy }
    environment:
      MYSQL_HOST: hippo-mysql
      MYSQL_PORT: 3306
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      REDIS_HOST: hippo-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    ports:
      - "127.0.0.1:${API_PORT}:18181"
      - "127.0.0.1:${WS_PORT}:18182"
    networks: [hippo-net]

  hippo-frontend:
    image: ${FRONTEND_IMAGE}
    container_name: hippo-frontend
    restart: unless-stopped
    depends_on: [hippo-backend]
    ports:
      - "127.0.0.1:${FRONT_PORT}:8080"
    networks: [hippo-net]

networks:
  hippo-net:
    name: hippo-net

volumes:
  hippo_mysql_data:
  hippo_redis_data:
EOF

  echo "âœ… å·²ç”Ÿæˆ ${COMPOSE_FILE}"
}

compose_up() {
  cd "${BASE_DIR}"
  echo "ðŸš€ å¯åŠ¨æœåŠ¡..."
  docker compose --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" up -d
  echo "âœ… å·²å¯åŠ¨"
}

compose_down_keep_vol() { cd "${BASE_DIR}"; docker compose --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" down; }
compose_down_purge()    { cd "${BASE_DIR}"; docker compose --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" down -v; }

show_status() {
  cd "${BASE_DIR}"
  docker compose --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" ps
  echo
  echo "æœ¬æœºç«¯å£ç›‘å¬ï¼ˆåªç»‘å®š 127.0.0.1ï¼‰ï¼š"
  ss -lntp | grep -E ':(8080|18181|18182)\b' || true
}

show_logs() {
  local svc="${1:-}"
  [[ -n "${svc}" ]] || { echo "è¯·æŒ‡å®šæœåŠ¡åï¼Œæ¯”å¦‚: logs backend"; exit 1; }
  cd "${BASE_DIR}"
  docker compose --env-file "${ENV_FILE}" -f "${COMPOSE_FILE}" logs -n 200 -f "hippo-${svc}"
}

main() {
  ensure_compose
  ensure_dirs

  local cmd="${1:-install}"
  case "${cmd}" in
    install|update)
      write_env_if_missing
      download_init_sql
      write_compose
      compose_up
      show_status
      ;;
    uninstall) compose_down_keep_vol; echo "âœ… å·²å¸è½½å®¹å™¨ï¼ˆæ•°æ®å·ä¿ç•™ï¼‰" ;;
    purge)     compose_down_purge;    echo "âœ… å·²å½»åº•æ¸…ç©ºï¼ˆå«æ•°æ®å·ï¼‰" ;;
    status)    show_status ;;
    logs)      show_logs "${2:-}" ;;
    -h|--help|help) usage ;;
    *) echo "æœªçŸ¥å‘½ä»¤: ${cmd}"; usage; exit 1 ;;
  esac
}

main "$@"

